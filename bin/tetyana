#!/usr/bin/env bash
# =============================================================================
# Tetyana v12 — ATLAS LangGraph Edition Binary Wrapper
# KONTUR Protocol Bridge для автоматизації macOS
# Автор: Кізима Олег Миколайович
# Україна, 2025 | Всі права захищені ©
# =============================================================================

set -e

# Отримати директорію скрипту
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Шляхи (unified venv in project root)
PYTHON_VENV="$PROJECT_ROOT/venv/bin/python3"
KONTUR_BRIDGE="$PROJECT_ROOT/src/kontur/organs/tetyana_bridge.py"
PYTHON_AGENT="$PROJECT_ROOT/src/kontur/organs/tetyana_agent.py"
ENV_FILE="$PROJECT_ROOT/.env"

# Fallback to old location for backward compatibility
if [ ! -f "$PYTHON_VENV" ] && [ -f "$PROJECT_ROOT/python/venv/bin/python3" ]; then
    PYTHON_VENV="$PROJECT_ROOT/python/venv/bin/python3"
fi

# Перевірити наявність Python
if [ ! -f "$PYTHON_VENV" ]; then
    echo "❌ Python venv не знайдено: $PYTHON_VENV"
    echo "Будь ласка, переконайтеся, що віртуальне оточення встановлено."
    exit 1
fi

# Перевірити наявність KONTUR бриджа
if [ ! -f "$KONTUR_BRIDGE" ]; then
    echo "❌ KONTUR бридж не знайдено: $KONTUR_BRIDGE"
    echo "Використовуємо основний агент..."
    PYTHON_AGENT_TO_RUN="$PYTHON_AGENT"
else
    PYTHON_AGENT_TO_RUN="$KONTUR_BRIDGE"
fi

# Перевірити наявність агента
if [ ! -f "$PYTHON_AGENT" ]; then
    echo "❌ Python агент не знайдено: $PYTHON_AGENT"
    exit 1
fi

# Завантажити змінні оточення з .env
if [ -f "$ENV_FILE" ]; then
    export $(grep -v '^#' "$ENV_FILE" | xargs)
fi

# Встановити змінні оточення для Python
export PYTHONUNBUFFERED=1
export PYTHONDONTWRITEBYTECODE=1

# Виконати агента з аргументами через KONTUR бридж
"$PYTHON_VENV" "$PYTHON_AGENT_TO_RUN" "$@"
